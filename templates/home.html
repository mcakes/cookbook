<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Recipe Collection</title>
    <link rel="stylesheet" href="recipes.css">
</head>
<body class="light">
    <button id="theme-toggle" aria-label="Toggle dark mode"></button>
    <div class="home-container">
        <h2>Recipe Collection</h2>
        
        <div class="filter-section">
            <div class="filter-title">Filter by Tags:</div>
            <div class="tags-container" id="tag-filter">
                $all_tags
            </div>
        </div>
        
        <div class="recipe-list">
            $recipes
        </div>
    </div>
    
    <script>
      // Theme toggle functionality
      const toggle = document.getElementById("theme-toggle");
      const root = document.body;

      // restore saved preference
      const saved = localStorage.getItem("theme");
      if (saved) root.classList.toggle("dark", saved === "dark");

      toggle.addEventListener("click", () => {
        const isDark = root.classList.toggle("dark");
        localStorage.setItem("theme", isDark ? "dark" : "light");
      });

      // Tag filtering functionality
      const tagChips = document.querySelectorAll('.tag-chip');
      const recipeItems = document.querySelectorAll('.recipe-item');
      
      // Parse URL parameters
      function getUrlParams() {
        const params = new URLSearchParams(window.location.search);
        return params.getAll('tag');
      }
      
      // Update URL with current active tags
      function updateUrl(activeTags) {
        const url = new URL(window.location);
        url.searchParams.delete('tag');
        activeTags.forEach(tag => url.searchParams.append('tag', tag));
        window.history.pushState({}, '', url);
      }
      
      // Filter recipes based on active tags
      function filterRecipes(activeTags) {
        recipeItems.forEach(item => {
          if (activeTags.length === 0) {
            // No filters, show all recipes
            item.classList.remove('hidden');
          } else {
            // Check if recipe has all active tags
            const recipeTags = item.dataset.tags ? item.dataset.tags.split(',') : [];
            const hasAllTags = activeTags.every(tag => recipeTags.includes(tag));
            item.classList.toggle('hidden', !hasAllTags);
          }
        });
      }
      
      // Get currently active tags
      function getActiveTags() {
        return Array.from(tagChips)
          .filter(chip => chip.classList.contains('active'))
          .map(chip => chip.dataset.tag);
      }
      
      // Initialize page based on URL parameters
      function initializePage() {
        const urlTags = getUrlParams();
        
        if (urlTags.length === 0) {
          // No URL params, no tags active (show all recipes)
          tagChips.forEach(chip => chip.classList.remove('active'));
        } else {
          // Activate only the tags specified in URL
          tagChips.forEach(chip => {
            chip.classList.toggle('active', urlTags.includes(chip.dataset.tag));
          });
        }
        
        filterRecipes(getActiveTags());
      }
      
      // Handle tag chip clicks
      tagChips.forEach(chip => {
        chip.addEventListener('click', () => {
          chip.classList.toggle('active');
          const activeTags = getActiveTags();
          updateUrl(activeTags);
          filterRecipes(activeTags);
        });
      });
      
      // Initialize on page load
      initializePage();
      
      // Handle browser back/forward
      window.addEventListener('popstate', initializePage);
    </script>
</body>
</html>